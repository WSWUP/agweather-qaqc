<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agweatherqaqc.agweatherqaqc &mdash; agweather-qaqc 1.0.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=1ed6394b"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            agweather-qaqc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installing agweather-qaqc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_preparation.html">Data Preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qc_information.html">QC Procedure Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">agweatherqaqc</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">agweather-qaqc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">agweatherqaqc.agweatherqaqc</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agweatherqaqc.agweatherqaqc</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">bokeh.layouts</span> <span class="kn">import</span> <span class="n">gridplot</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">reset_output</span><span class="p">,</span> <span class="n">save</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">agweatherqaqc</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">calc_functions</span><span class="p">,</span> <span class="n">input_functions</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">qaqc_functions</span>
<span class="kn">from</span> <span class="nn">refet.calcs</span> <span class="kn">import</span> <span class="n">_wind_height_adjust</span>
<span class="kn">import</span> <span class="nn">warnings</span>


<div class="viewcode-block" id="WeatherQC">
<a class="viewcode-back" href="../../agweatherqaqc.html#agweatherqaqc.agweatherqaqc.WeatherQC">[docs]</a>
<span class="k">class</span> <span class="nc">WeatherQC</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The WeatherQC class is a holistic package for the QC of agricultural weather data.</span>

<span class="sd">    It requires the filepath to a config file, and from that file does everything necessary for to enable</span>
<span class="sd">    the end user to QC the data from a station. The class handles the reading in of data, sanitizing of inputs,</span>
<span class="sd">    plotting and logging the correction of said data, and finally saving the final data for in other analyses.</span>

<span class="sd">    Usually, weather stations from the same source or network have the same file structure, so WeatherQC features</span>
<span class="sd">    an optional input of the filepath to a metadata file to process multiple stations using the same input file.</span>

<span class="sd">    # Example:</span>
<span class="sd">        &gt;&gt;&gt; from agweatherqaqc.agweatherqaqc import WeatherQC</span>
<span class="sd">        &gt;&gt;&gt; config_path = &#39;test_files/test_config.ini&#39;</span>
<span class="sd">        &gt;&gt;&gt; metadata_path = &#39;test_files/test_metadata.xlsx&#39;</span>
<span class="sd">        &gt;&gt;&gt; station_qaqc = WeatherQC(config_path, metadata_path, gridplot_columns=1)</span>
<span class="sd">        &gt;&gt;&gt; station_qaqc.process_station()</span>

<span class="sd">    Both the config and metadata files have requirements on file structure and contents. The files</span>
<span class="sd">    contained within the `./test_data/` directory can serve as templates to copy from or modify.</span>

<span class="sd">    Please see the documentation of `WeatherQC.process_station()`, as well as the documentation for the functions</span>
<span class="sd">    within `agweatherqaqc.qaqc_functions` and `agweatherqaqc.calc_functions` for more information on</span>
<span class="sd">    the overall process and individual steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file_path</span><span class="o">=</span><span class="s1">&#39;config.ini&#39;</span><span class="p">,</span> <span class="n">metadata_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridplot_columns</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_path</span> <span class="o">=</span> <span class="n">config_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span> <span class="o">=</span> <span class="n">metadata_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gridplot_columns</span> <span class="o">=</span> <span class="n">gridplot_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">script_mode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_iterations_pre_corrections</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># initially do only a few to save time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_iterations_post_corrections</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># do MC approach after all data has been corrected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_bokeh</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_obtain_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Obtain initial data and put it into a dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_series</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">input_functions</span><span class="o">.</span><span class="n">_obtain_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;station_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;log_file_path&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station_lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;station_latitude&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station_lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;station_longitude&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station_elev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;station_elevation&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_anemometer_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;anemometer_height&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_fill_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;missing_output_value&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;folder_path&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;auto_flag&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;fill_flag&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System: Raw data successfully extracted from station file.&quot;</span><span class="p">)</span>

        <span class="c1"># Extract individual variables from data frame back into to numpy arrays.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">tavg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">tdew</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">ea</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">rhavg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">rhmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">rhmin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">rs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_precip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">precip</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_file_path</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span> <span class="o">+</span>
                                 <span class="s2">&quot;/correction_files/output_data/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_name</span> <span class="o">+</span> <span class="s2">&quot;_output&quot;</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_secondary_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate secondary variables from initial ones</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System: Now calculating secondary variables based on data provided.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station_pressure</span> <span class="o">=</span> <span class="mf">101.3</span> <span class="o">*</span> <span class="p">(((</span><span class="mi">293</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.0065</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_elev</span><span class="p">))</span> <span class="o">/</span> <span class="mi">293</span><span class="p">)</span> <span class="o">**</span> <span class="mf">5.26</span><span class="p">)</span>  <span class="c1"># units kPa, EQ 3 ASCE</span>

        <span class="c1"># Calculate DOY from Y/M/D values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_doy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">):</span>
            <span class="c1"># Create list of string DOY values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_doy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_day</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%j&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_doy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_doy</span><span class="p">)))</span>  <span class="c1"># Converts list of string values into ints</span>

        <span class="c1"># Calculate tavg if it is not provided by dataset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">tavg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Tavg not provided</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Tavg is provided, no action needs to be taken</span>
            <span class="k">pass</span>

        <span class="c1"># Figure out which humidity variables are provided and calculate Ea and TDew if needed</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span>\
            <span class="n">calc_humidity_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">ea</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">tdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmax</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhavg</span><span class="p">)</span>

        <span class="c1"># Calculates secondary temperature values and mean monthly counterparts</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_delta_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_not</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_k_not</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_tdew</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span> \
            <span class="n">calc_temperature_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Tdew_ko will have all missing values of tdew filled in with tmin - Ko curve method, but will keep missing</span>
<span class="sd">            values if the underlying tmin is also missing. Currently it is just a copy of TDew, but filling will occur</span>
<span class="sd">            after temp/humidity has been corrected. If the user does not correct data then this will stay unfilled, but</span>
<span class="sd">            that is an edge case and not the intent of this code</span>
<span class="sd">            </span>
<span class="sd">            Tdew_ko is distinct from complete_tdew in that it only fills in an day&#39;s observation if there is a </span>
<span class="sd">            tmin observation presentfor that day. Complete_tdew has a filled in observation for every day because it is</span>
<span class="sd">            based on a tmin that has been filled with random samples from a normal distribution. Unless the user </span>
<span class="sd">            specifically asks for this simulated data to be saved then it is only used to create a complete record of </span>
<span class="sd">            Rso for Rs correction and then is discarded.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew_ko</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            This script uses multiple vapor pressure (ea) variables. As a reference for readability:</span>
<span class="sd">    </span>
<span class="sd">            data_ea = either ea data provided by the station or ea that has been calculated by whatever the &#39;best&#39;</span>
<span class="sd">                      humidity variable was in the input file. If it is the latter, this ea will have all the gaps and</span>
<span class="sd">                      issues (like drift) that the underlying variable had.</span>
<span class="sd">    </span>
<span class="sd">            compiled_ea = the script creates as complete a record as possible of ea values by calculating ea from </span>
<span class="sd">                       &#39;worse&#39; variables should there be gaps in the more preferred ones. It only samples from data </span>
<span class="sd">                       that has been provided by the dataset. By the end of this process, the only gaps that will exist </span>
<span class="sd">                       will match the gaps that exist within Tmin. The preference is as follows:</span>
<span class="sd">    </span>
<span class="sd">                       (provided) Ea &gt; (provided) TDew &gt; RH Max and Min &gt; RH Avg &gt; TDew generated from TMin - Ko curve</span>
<span class="sd">    </span>
<span class="sd">            complete_ea = this is compiled ea but with all of the gaps filled in with TDew generated from </span>
<span class="sd">                       TMin - Ko Curve, and all gaps in TMin filled in by sampling from a monthly normal distribution</span>
<span class="sd">                       of values. Unless the user specifically wants to export this day (option is in config file)</span>
<span class="sd">                       then this data is only used to create a complete record of Rso values for Rs correction,</span>
<span class="sd">                       and then is discarded at the end.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span><span class="n">calc_compiled_ea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">tdew</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew_ko</span><span class="p">)</span>

        <span class="c1"># Calculates rso and grass/alfalfa reference evapotranspiration from refet package</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid value encountered&#39;</span><span class="p">)</span>  <span class="c1"># invalid value warning for nans</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">etr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_eto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_etr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span>\
            <span class="n">calc_rso_and_refet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_elev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_anemometer_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_doy</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">)</span>

        <span class="c1"># Calculate original and optimized Thornton Running solar radiation using a monte carlo approach.</span>
        <span class="c1"># Only do a few number of iterations here as this will be recomputed once the data has been corrected</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_rs_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_orig_rs_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_rs_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_opt_rs_tr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span> \
            <span class="n">calc_org_and_opt_rs_tr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_iterations_pre_corrections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_delta_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">)</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>  <span class="c1"># reset warning filter to default</span>

        <span class="c1">#########################</span>
        <span class="c1"># Back up original data to later save it to output file</span>
        <span class="c1"># Values are also used to generate delta values of corrected data - original data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Create an unlinked copy of read-in values dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;rso&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rso</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;etr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;eto&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;compiled_ea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span>

        <span class="c1"># Create datetime variables that will be used by bokeh plot and correction functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_day</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm_dt_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm_data_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span> <span class="nf">_correct_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Correct data</span>
<span class="sd">            Loop where user selects an option, corrects it,</span>
<span class="sd">            then the script recalculates all downstream variables,</span>
<span class="sd">            and finally prompts the user again.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System: Now beginning correction on data.&quot;</span><span class="p">)</span>
        <span class="c1"># create a flag to check if composite ea has been adjusted or not before correcting solar radiation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">humidity_adjusted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Complete_vars are going to be filled for the whole record, which may be put into output file if user requests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span>

        <span class="c1"># Create arrays that will track which values have been filled (replace missing data) by the script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_tdew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_rso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>

        <span class="c1"># Begin loop for correcting variables</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">reset_output</span><span class="p">()</span>  <span class="c1"># clears bokeh output, prevents ballooning file sizes</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Please select which of the following variables you want to correct&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 1 for TMax and TMin.&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 2 for TMin and TDew, if TDew was provided.&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 3 for Windspeed.&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 4 for Precipitation.&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 5 for Solar Radiation (Rs).&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 6 for Vapor Pressure (Ea), if it was provided.&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 7 for RH Maximum and Minimum, if they were provided.&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 8 for RH Average, if it was provided.&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 9 to adjust how compiled humidity is sourced.&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   Enter 0 to stop applying corrections.&#39;</span>
                  <span class="p">)</span>

            <span class="n">choice_loop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">choice_loop</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_int_input</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Enter your selection: &quot;</span><span class="p">)</span>
                <span class="c1"># The following if statements check whether user tries to correct a variable that was not provided</span>
                <span class="c1"># or make sure correction is being done in the ideal order</span>
                <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">tdew</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Dewpoint temperature was not provided by the file, please choose a different option.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">ea</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Vapor Pressure was not provided by the file, please choose a different option.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmax</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">RHMax and RHMin were not provided by the file, please choose a different option.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhavg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">RHAvg was not provided by the file, please choose a different option.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">humidity_adjusted</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Before correcting solar radiation, did you want to adjust compiled humidity?.&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Doing so may allow you to get the best possible humidity record for Rs correction.&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Enter 1 to adjust compiled humidity or 0 to skip.&#39;</span><span class="p">)</span>

                    <span class="n">humid_choice</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_int_input</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Enter your selection: &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">humid_choice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># change original choice to the adjust humidity option</span>
                        <span class="n">user</span> <span class="o">=</span> <span class="mi">9</span>
                    <span class="n">choice_loop</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">choice_loop</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1">##########</span>
            <span class="c1"># Correcting individual variables based on user choice</span>
            <span class="c1"># Correcting Max/Min Temperature data</span>
            <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">)</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span><span class="p">)</span>
            <span class="c1"># Correcting Min/Dew Temperature data</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span><span class="p">)</span>
            <span class="c1"># Correcting Windspeed</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">)</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span><span class="p">)</span>
            <span class="c1"># Correcting Precipitation</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_precip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">)</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_precip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span><span class="p">)</span>
            <span class="c1"># Correcting Solar radiation</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">)</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span><span class="p">)</span>
            <span class="c1"># Correcting Vapor Pressure</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">)</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span><span class="p">)</span>
            <span class="c1"># Correcting Relative Humidity Max and Min</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">)</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span><span class="p">)</span>
            <span class="c1"># Correcting Relative Humidity Average</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">)</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_mode</span><span class="p">)</span>
            <span class="c1"># Adjusting compiled_ea</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span> <span class="o">=</span> <span class="n">qaqc_functions</span><span class="o">.</span>\
                    <span class="n">compiled_humidity_adjustment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">tdew</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew_ko</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmax</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmin</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhavg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">humidity_adjusted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># user quits, exit out of loop</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">System: Now finishing up corrections.&#39;</span><span class="p">)</span>
                <span class="c1"># Break here because all recalculations were done at the end of the last loop iteration</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">user</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="mi">6</span> <span class="o">&lt;=</span> <span class="n">user</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># User has corrected temperature, so fill all missing values with a normal distribution</span>
                    <span class="c1"># Reset &#39;complete&#39; vars as the underlying var has been changed.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">)</span>

                    <span class="c1"># Remove corresponding TAvg observations after outliers have been removed from TMax and TMin</span>
                    <span class="n">tmax_removed_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">)))</span>  <span class="c1"># array of indices of nans</span>
                    <span class="n">tmin_removed_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">)))</span>  <span class="c1"># array of indices of nans</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span><span class="p">[</span><span class="n">tmax_removed_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span><span class="p">[</span><span class="n">tmin_removed_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                    <span class="c1"># Create mean monthly and standard deviation</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">std_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">std_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                        <span class="n">temp_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span> <span class="o">==</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">temp_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp_indexes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmax</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">[</span><span class="n">temp_indexes</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">std_tmax</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">[</span><span class="n">temp_indexes</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmin</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">[</span><span class="n">temp_indexes</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">std_tmin</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">[</span><span class="n">temp_indexes</span><span class="p">])</span>

                    <span class="c1"># Fill missing observations with samples from a normal distribution with monthly mean and variance</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm_tmax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">std_tmax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm_tmin</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">std_tmin</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> \
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">):</span>
                            <span class="c1"># This is a logical check to make sure that tmax is sufficiently distant from tmin once</span>
                            <span class="c1"># they have been filled in, tmax needs to be warmer than tmin and daily temp isn&#39;t constant</span>
                            <span class="c1"># so there should be at least a small difference in tmax-tmin</span>

                            <span class="c1"># todo the below lines always provide a higher than average tmax</span>
                            <span class="c1">#   and a lower than average tmin, this can be eventually improved</span>
                            <span class="c1"># Fill this observation in with  mm observation with the difference of 1/2 of mm delta t</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                                                    <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_delta_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmin</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> \
                                <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_delta_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># data is different enough to appear valid</span>
                            <span class="k">pass</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_mode</span><span class="p">:</span>
                        <span class="c1"># we are filling in data, so copy all the filled versions onto the original temperature</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if we are not filling, we will hold the copies to later fill in rso, but will reset fill</span>
                        <span class="c1"># tracking variables</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># user did not correct option 1</span>
                    <span class="k">pass</span>

                <span class="c1"># Figure out which humidity variables are provided and recalculate Ea and TDew if needed</span>
                <span class="c1"># This function is safe to use after correcting because it tracks what variable was provided by the data</span>
                <span class="c1"># and recalculates appropriately. It doesn&#39;t overwrite provided variables with calculated versions.</span>
                <span class="c1"># Ex. if only TDew is provided, it recalculates ea while returning original provided tdew</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span>\
                    <span class="n">calc_humidity_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">tdew</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhavg</span><span class="p">)</span>

                <span class="c1"># Recalculates secondary temperature values and mean monthly counterparts</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_delta_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_not</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_k_not</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_tdew</span><span class="p">)</span> <span class="o">=</span> \
                    <span class="n">calc_functions</span><span class="o">.</span><span class="n">calc_temperature_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span>

                <span class="c1"># Since we are recalculating humidity variables, we also need to reset tdew_ko to ensure it matches the</span>
                <span class="c1"># underlying unfilled tdew. It is filled later after this once the user corrects a humidity var</span>
                <span class="c1"># so this reset is acceptable</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew_ko</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="mi">6</span> <span class="o">&lt;=</span> <span class="n">user</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>

                    <span class="c1"># Reset &#39;complete&#39; version as underlying variable may have changed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)</span>
<span class="w">                    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                        Fill in any missing tdew data with tmin - k0 curve.</span>
<span class="sd">                        </span>
<span class="sd">                        As detailed above, data_tdew_ko only fills in missing tdew observations with real tmin obs,</span>
<span class="sd">                        while complete_tdew is a full record filled in using a filled in tmin.</span>
<span class="sd">                        </span>
<span class="sd">                        Nothing occurs if this fill code is run a second time because vars are already filled unless</span>
<span class="sd">                        correction methods throw out data, in which case we need to refill for the complete record</span>
<span class="sd">                        that Rs correction requires.</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>

                            <span class="c1"># Tdew_ko will have gaps that match gaps in Tmin</span>
                            <span class="c1"># Complete_tdew will match complete_tmin in having no gaps</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew_ko</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_k_not</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_k_not</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fill_tdew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If TDew isn&#39;t empty then nothing is required to be done.</span>
                            <span class="k">pass</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_mode</span><span class="p">:</span>
                        <span class="c1"># we are filling in data, so copy all the filled versions onto the original arrays</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if we are not filling, we will hold the copies to later fill in rso, but will reset fill</span>
                        <span class="c1"># tracking variables</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fill_tdew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># user did not select option 2 or 6-8</span>
                    <span class="k">pass</span>

<span class="w">                </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    Recreate the &#39;compiled&#39; ea as temperature or humidity vars were corrected and may have changed the</span>
<span class="sd">                    data underlying the compiled ea. Once that is done we will fill in all the gaps with the </span>
<span class="sd">                    variable &#39;complete_tdew&#39; so that a complete record of ea exists for rs correction</span>
<span class="sd">                    </span>
<span class="sd">                    The gaps in compiled_ea are reset every time temperature or humidity is corrected so this code is </span>
<span class="sd">                    okay to run multiple times</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span><span class="n">calc_compiled_ea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">tdew</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmax</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmin</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhavg</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew_ko</span><span class="p">)</span>

                <span class="c1"># Reset &#39;complete&#39; version as underlying variable may have changed.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6108</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">17.27</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                                                                                  <span class="o">+</span> <span class="mf">237.3</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fill_ea</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Ea is provided and the index is not empty, do nothing to avoid overwriting actual data</span>
                    <span class="k">pass</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_mode</span><span class="p">:</span>
                    <span class="c1"># we are filling in data, so copy all the filled versions onto the original arrays</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if we are not filling, we will hold the copies to later fill in rso, but will reset fill</span>
                    <span class="c1"># tracking variables</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fill_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>  <span class="c1"># User has adjusted how the compiled humidity is sourced, recreate complete_ea</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6108</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">17.27</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span>
                                                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_tdew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">237.3</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fill_ea</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># the index is not empty, do nothing to avoid overwriting actual data</span>
                    <span class="k">pass</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_mode</span><span class="p">:</span>
                    <span class="c1"># we are filling in data, so copy all the filled versions onto the original arrays</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if we are not filling, we will hold the copies to later fill in rso, but will reset fill</span>
                    <span class="c1"># tracking variables</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fill_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># user did not select options 1,2, 6, 7, 8, or 9.</span>
                <span class="k">pass</span>

<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                Even if the user doesn&#39;t want to put filled data into their output file, we still need to use complete</span>
<span class="sd">                records to get a complete record of Rso for use in Rs correction. This completed rso is only used for </span>
<span class="sd">                this step and is not written as data to the output file</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_mode</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;                  </span>
<span class="sd">                    This recalculates Rso and ETr values using the filled &#39;completed_&#39; versions to provide a complete</span>
<span class="sd">                    record of ETr values.</span>
<span class="sd">                    </span>
<span class="sd">                    If this code is executing then &#39;data_&#39; vars have already been replaced by their &#39;completed_&#39; </span>
<span class="sd">                    versions so the code is accurate in calling them &#39;data_&#39;</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid value encountered&#39;</span><span class="p">)</span>  <span class="c1"># catch invalid value warning, nans</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">etr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_eto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_etr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span> \
                    <span class="n">calc_rso_and_refet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_elev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_anemometer_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_doy</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    User doesn&#39;t want to keep filled in data, so use complete versions to create a filled version of</span>
<span class="sd">                    rso while saving the other outputs of calc_rso_and_refet as temporary names which are unused to </span>
<span class="sd">                    prevent them from impacting later calculations</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid value encountered&#39;</span><span class="p">)</span>  <span class="c1"># catch invalid value warning, nans</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mm_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_etr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mm_eto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mm_etr</span><span class="p">)</span> <span class="o">=</span> \
                    <span class="n">calc_functions</span><span class="o">.</span><span class="n">calc_rso_and_refet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_elev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_anemometer_height</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">data_doy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmax</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">complete_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">resetwarnings</span><span class="p">()</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            At this point the user has finished correcting all variables they want to.</span>
<span class="sd">            </span>
<span class="sd">            We now recalculate original and optimized Thornton-Running Solar Radiation.</span>
<span class="sd">            Additionally, if the user is electing to fill data then we fill in all gaps of data_rs </span>
<span class="sd">            with the optimized thornton running solar radiation.</span>
<span class="sd">            </span>
<span class="sd">            Also, only if the user wants, we fill in all gaps of wind data using samples from a normal distribution.</span>
<span class="sd">            </span>
<span class="sd">            Finally, we do one final calculation of Rso/ETr with all the final versions of variables. If the user does</span>
<span class="sd">            NOT want to fill in data, this final calculation of Rso will replace the filled one used for Solar</span>
<span class="sd">            Radiation correction with one using only real data.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orig_rs_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_orig_rs_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_rs_tr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_opt_rs_tr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span> \
            <span class="n">calc_org_and_opt_rs_tr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_iterations_post_corrections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_delta_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">)</span>

        <span class="c1"># This section provides for the filling of data should fill_mode be set to true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm_ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
            <span class="n">temp_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span> <span class="o">==</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">temp_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp_indexes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mm_ws</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">[</span><span class="n">temp_indexes</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">std_ws</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">[</span><span class="n">temp_indexes</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_mode</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">):</span>
                <span class="c1"># fill data_rs with rs_tr and data_ws with an exponential function centered on mm_ws for that month</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_rs_tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fill_rs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_rs_tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If rs isn&#39;t empty then nothing is required to be done.</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mm_ws</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">std_ws</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>  <span class="c1"># check to see if filled windspeed is lower than reasonable</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">fill_ws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If ws isn&#39;t empty then nothing is required to be done.</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Recalculate eto and etr one final time</span>
        <span class="c1"># This also overwrites the filled Rso, so we will create a copy for posterity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_rso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">)</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">etr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_eto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_etr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calc_functions</span><span class="o">.</span> \
            <span class="n">calc_rso_and_refet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">station_lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_elev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_anemometer_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_doy</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Makes and saves histogram and composite plots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#########################</span>
        <span class="c1"># Histograms of original data</span>
        <span class="c1"># Generates composite plot of specific variables before correction</span>
        <span class="c1"># We fill these variables by sampling a normal distribution, so we use this plot mainly as evidence for that.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_bokeh</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">script_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ws_hist</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">histogram_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">)],</span>
                                          <span class="s1">&#39;Windspeed&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;m/s&#39;</span><span class="p">)</span>
            <span class="n">tmax_hist</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">histogram_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">)],</span>
                                            <span class="s1">&#39;TMax&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;degrees C&#39;</span><span class="p">)</span>
            <span class="n">tmin_hist</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">histogram_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">)],</span>
                                            <span class="s1">&#39;TMin&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;degrees C&#39;</span><span class="p">)</span>
            <span class="n">tavg_hist</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">histogram_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">)],</span>
                                            <span class="s1">&#39;TAvg&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;degrees C&#39;</span><span class="p">)</span>
            <span class="n">tdew_hist</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">histogram_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">)],</span>
                                            <span class="s1">&#39;TDew&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;degrees C&#39;</span><span class="p">)</span>
            <span class="n">k_not_hist</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">histogram_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_not</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_not</span><span class="p">)],</span>
                                            <span class="s1">&#39;Ko&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;degrees C&#39;</span><span class="p">)</span>

            <span class="n">output_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span> <span class="o">+</span> <span class="s2">&quot;/correction_files/histograms/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_name</span> <span class="o">+</span> <span class="s1">&#39;_histograms.html&#39;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">station_name</span> <span class="o">+</span> <span class="s1">&#39; histograms&#39;</span><span class="p">)</span>

            <span class="n">save</span><span class="p">(</span><span class="n">gridplot</span><span class="p">([</span><span class="n">ws_hist</span><span class="p">,</span> <span class="n">tmax_hist</span><span class="p">,</span> <span class="n">tmin_hist</span><span class="p">,</span> <span class="n">tavg_hist</span><span class="p">,</span> <span class="n">tdew_hist</span><span class="p">,</span> <span class="n">k_not_hist</span><span class="p">],</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">toolbar_location</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>

        <span class="c1">#########################</span>
        <span class="c1"># Generate bokeh composite plot</span>
        <span class="c1"># Creates one large plot featuring all variables as subplots, used to get a concise overview of the full dataset</span>
        <span class="c1"># This output will be generated twice, first to plot data before correction, and then again</span>
        <span class="c1"># to plot data after correction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_bokeh</span><span class="p">:</span>  <span class="c1"># Flag to create graphs or not</span>
            <span class="n">reset_output</span><span class="p">()</span>
            <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">x_size</span> <span class="o">=</span> <span class="mi">1200</span>
            <span class="n">y_size</span> <span class="o">=</span> <span class="mi">400</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">script_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">output_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span> <span class="o">+</span> <span class="s2">&quot;/correction_files/before_graphs/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_name</span> <span class="o">+</span>
                            <span class="s2">&quot;_before_corrections_composite_graph.html&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System: Now creating pre-correction composite bokeh graph.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">script_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">output_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span> <span class="o">+</span> <span class="s2">&quot;/correction_files/after_graphs/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_name</span> <span class="o">+</span>
                            <span class="s2">&quot;_after_corrections_composite_graph.html&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System: Now creating post-correction composite bokeh graph.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Incorrect setup of script mode variable, raise an error</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incorrect parameters: script mode is not set to a valid option.&#39;</span><span class="p">)</span>

            <span class="c1"># Temperature Maximum and Minimum Plot</span>
            <span class="n">plot_tmax_tmin</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_tmax_tmin</span><span class="p">)</span>
            <span class="c1"># Temperature Minimum and Dewpoint Plot</span>
            <span class="n">plot_tmin_tdew</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plot_tmax_tmin</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_tmin_tdew</span><span class="p">)</span>

            <span class="c1"># &#39;Completed&#39; vapor pressure plot</span>
            <span class="n">plot_comp_ea</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span>
                                          <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;Composite &#39;</span><span class="p">,</span> <span class="n">plot_tmax_tmin</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_comp_ea</span><span class="p">)</span>

            <span class="c1"># vapor pressure plot that was just the provided dataset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">ea</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">plot_data_ea</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span>
                                              <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;Provided &#39;</span><span class="p">,</span> <span class="n">plot_tmax_tmin</span><span class="p">)</span>
                <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_data_ea</span><span class="p">)</span>

            <span class="c1"># rh max and rh min plot if it was provided in dataset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmax</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhmin</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># RH max and RH min</span>
                <span class="n">plot_rhmax_rhmin</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plot_tmax_tmin</span><span class="p">)</span>
                <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_rhmax_rhmin</span><span class="p">)</span>

            <span class="c1"># rh avg if it was provided in the dataset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ser</span><span class="o">.</span><span class="n">rhavg</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># RH Avg</span>
                <span class="n">plot_rhavg</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plot_tmax_tmin</span><span class="p">)</span>
                <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_rhavg</span><span class="p">)</span>

            <span class="c1"># Mean Monthly Temperature Minimum and Dewpoint</span>
            <span class="n">plot_mm_tmin_tdew</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_tmin</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">mm_tdew</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;MM &#39;</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_mm_tmin_tdew</span><span class="p">)</span>

            <span class="c1"># Mean Monthly k0 curve (Tmin-Tdew)</span>
            <span class="n">plot_mm_k_not</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_k_not</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">mm_data_null</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plot_mm_tmin_tdew</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_mm_k_not</span><span class="p">)</span>

            <span class="c1"># Solar radiation and clear sky solar radiation</span>
            <span class="n">plot_rs_rso</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">,</span>
                                         <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plot_tmax_tmin</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_rs_rso</span><span class="p">)</span>

            <span class="c1"># Windspeed</span>
            <span class="n">plot_ws</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span>
                                     <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plot_tmax_tmin</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_ws</span><span class="p">)</span>

            <span class="c1"># Precipitation</span>
            <span class="n">plot_precip</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_precip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_null</span><span class="p">,</span>
                                         <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plot_tmax_tmin</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_precip</span><span class="p">)</span>

            <span class="c1"># Optimized mean monthly Thornton-Running solar radiation and Mean Monthly solar radiation</span>
            <span class="n">plot_mm_opt_rs_tr</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_rs</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">mm_opt_rs_tr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;MM Optimized &#39;</span><span class="p">,</span> <span class="n">plot_mm_tmin_tdew</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_mm_opt_rs_tr</span><span class="p">)</span>

            <span class="c1"># Optimized mean monthly Thornton-Running solar radiation and Mean Monthly solar radiation</span>
            <span class="n">plot_mm_orig_rs_tr</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">line_plot</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_dt_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_rs</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">mm_orig_rs_tr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;MM Original &#39;</span><span class="p">,</span> <span class="n">plot_mm_tmin_tdew</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_mm_orig_rs_tr</span><span class="p">)</span>

            <span class="c1"># Now construct grid plot out of all the subplots</span>
            <span class="n">number_of_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_list</span><span class="p">)</span>
            <span class="n">number_of_rows</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">number_of_plots</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridplot_columns</span><span class="p">)</span>

            <span class="n">grid_of_plots</span> <span class="o">=</span> <span class="p">[([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_rows</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_rows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gridplot_columns</span><span class="p">):</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">grid_of_plots</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">gridplot</span><span class="p">(</span><span class="n">grid_of_plots</span><span class="p">,</span> <span class="n">toolbar_location</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;stretch_width&#39;</span><span class="p">)</span>
            <span class="n">save</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates all the output files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#########################</span>
        <span class="c1"># Create necessary variables for generic metadata file, as well as</span>
        <span class="c1"># generate and fill metadata file</span>
        <span class="n">record_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">record_end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="c1"># Generate metadata output file that saves the site-specific data for each run (appended to end)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;correction_metadata.xlsx&#39;</span><span class="p">):</span>
            <span class="c1"># file does not exist, create new one</span>
            <span class="n">metadata_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Station&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_lat</span><span class="p">,</span>
                                          <span class="s1">&#39;Longitude&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_lon</span><span class="p">,</span> <span class="s1">&#39;station_elev_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_elev</span><span class="p">,</span>
                                          <span class="s1">&#39;record_start&#39;</span><span class="p">:</span> <span class="n">record_start</span><span class="p">,</span> <span class="s1">&#39;record_end&#39;</span><span class="p">:</span> <span class="n">record_end</span><span class="p">,</span>
                                          <span class="s1">&#39;anemom_height_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_anemometer_height</span><span class="p">,</span>
                                          <span class="s1">&#39;Filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file_path</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;correction_metadata.xlsx&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">,</span>
                                <span class="n">datetime_format</span><span class="o">=</span><span class="s1">&#39;YYYY-MM-DD HH:MM:SS&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">metadata_info</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Sheet1&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># file is already created, so we need to read it in, append our new information to the bottom of it</span>
            <span class="c1"># and then save the info</span>
            <span class="n">metadata_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;correction_metadata.xlsx&#39;</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">,</span> <span class="n">keep_default_na</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">new_meta_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Station&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_name</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_lat</span><span class="p">,</span>
                                          <span class="s1">&#39;Longitude&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_lon</span><span class="p">,</span> <span class="s1">&#39;station_elev_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_elev</span><span class="p">,</span>
                                          <span class="s1">&#39;record_start&#39;</span><span class="p">:</span> <span class="n">record_start</span><span class="p">,</span> <span class="s1">&#39;record_end&#39;</span><span class="p">:</span> <span class="n">record_end</span><span class="p">,</span>
                                          <span class="s1">&#39;anemom_height_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_anemometer_height</span><span class="p">,</span>
                                          <span class="s1">&#39;Filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file_path</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">output_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metadata_info</span><span class="p">,</span> <span class="n">new_meta_info</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s1">&#39;correction_metadata.xlsx&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">,</span>
                                <span class="n">datetime_format</span><span class="o">=</span><span class="s1">&#39;YYYY-MM-DD HH:MM:SS&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">output_metadata</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Sheet1&#39;</span><span class="p">)</span>

        <span class="c1"># if we are using a network-specific metadata file, update that another file has been processed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">processed</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">processed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">current_row</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">record_start</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">current_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">record_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">record_end</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">current_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">record_end</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">output_path</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">current_row</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file_path</span>

            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">,</span>
                                <span class="n">datetime_format</span><span class="o">=</span><span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Sheet1&#39;</span><span class="p">)</span>

        <span class="c1">#########################</span>
        <span class="c1"># Generate output file</span>
        <span class="c1"># Create any final variables, then create panda dataframes to save all the data</span>
        <span class="c1"># Includes the following sheets:</span>
        <span class="c1">#     Corrected Data : Actual corrected values</span>
        <span class="c1">#     Delta : Magnitude of difference between original data and corrected data</span>
        <span class="c1">#     Filled Data : Tracks which data points have been filled by script generated values instead of provided</span>
        <span class="c1"># Data that is provided and subsequently corrected by the script do not count as filled values.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System: Saving corrected data to .xslx file.&quot;</span><span class="p">)</span>

        <span class="c1"># Create any individually-requested output data</span>
        <span class="n">ws_2m</span> <span class="o">=</span> <span class="n">_wind_height_adjust</span><span class="p">(</span><span class="n">uz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span> <span class="n">zw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws_anemometer_height</span><span class="p">)</span>

        <span class="c1"># Create corrected-original delta numpy arrays</span>
        <span class="n">diff_tavg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">tavg</span><span class="p">)</span>
        <span class="n">diff_tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">tmax</span><span class="p">)</span>
        <span class="n">diff_tmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
        <span class="n">diff_tdew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">tdew</span><span class="p">)</span>
        <span class="n">diff_ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">ea</span><span class="p">)</span>
        <span class="n">diff_rhavg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">rhavg</span><span class="p">)</span>
        <span class="n">diff_rhmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">rhmax</span><span class="p">)</span>
        <span class="n">diff_rhmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">rhmin</span><span class="p">)</span>
        <span class="n">diff_rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">rs</span><span class="p">)</span>
        <span class="n">diff_rs_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_rs_tr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_rs_tr</span><span class="p">)</span>
        <span class="n">diff_rso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rso</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">rso</span><span class="p">)</span>
        <span class="n">diff_ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">ws</span><span class="p">)</span>
        <span class="n">diff_precip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_precip</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">precip</span><span class="p">)</span>
        <span class="n">diff_etr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">etr</span><span class="p">)</span>
        <span class="n">diff_eto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eto</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span><span class="o">.</span><span class="n">eto</span><span class="p">)</span>

        <span class="c1"># Create k0 array to output values</span>
        <span class="n">k_not_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_length</span><span class="p">)</span>
        <span class="n">k_not_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm_k_not</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>

        <span class="c1"># Create datetime for output dataframe</span>
        <span class="n">datetime_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_day</span><span class="p">})</span>
        <span class="n">datetime_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">datetime_df</span><span class="p">[[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]])</span>

        <span class="c1"># Create output dataframe</span>
        <span class="n">output_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span>
                                  <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_day</span><span class="p">,</span> <span class="s1">&#39;TAvg (C)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tavg</span><span class="p">,</span> <span class="s1">&#39;TMax (C)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmax</span><span class="p">,</span>
                                  <span class="s1">&#39;TMin (C)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tmin</span><span class="p">,</span> <span class="s1">&#39;TDew (C)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_tdew</span><span class="p">,</span>
                                  <span class="s1">&#39;Compiled Ea (kPa)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_ea</span><span class="p">,</span>
                                  <span class="s1">&#39;Vapor Pres (kPa)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ea</span><span class="p">,</span> <span class="s1">&#39;RHAvg (%)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhavg</span><span class="p">,</span>
                                  <span class="s1">&#39;RHMax (%)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmax</span><span class="p">,</span> <span class="s1">&#39;RHMin (%)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rhmin</span><span class="p">,</span> <span class="s1">&#39;Rs (w/m2)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rs</span><span class="p">,</span>
                                  <span class="s1">&#39;Opt_Rs_TR (w/m2)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_rs_tr</span><span class="p">,</span> <span class="s1">&#39;Rso (w/m2)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rso</span><span class="p">,</span>
                                  <span class="s1">&#39;Windspeed (m/s)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ws</span><span class="p">,</span> <span class="s1">&#39;Precip (mm)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_precip</span><span class="p">,</span>
                                  <span class="s1">&#39;ETr (mm)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">etr</span><span class="p">,</span> <span class="s1">&#39;ETo (mm)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eto</span><span class="p">,</span> <span class="s1">&#39;ws_2m (m/s)&#39;</span><span class="p">:</span> <span class="n">ws_2m</span><span class="p">},</span>
                                 <span class="n">index</span><span class="o">=</span><span class="n">datetime_df</span><span class="p">)</span>

        <span class="c1"># Creating difference dataframe to track amount of correction</span>
        <span class="n">delta_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span>
                                 <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_day</span><span class="p">,</span> <span class="s1">&#39;TAvg (C)&#39;</span><span class="p">:</span> <span class="n">diff_tavg</span><span class="p">,</span> <span class="s1">&#39;TMax (C)&#39;</span><span class="p">:</span> <span class="n">diff_tmax</span><span class="p">,</span>
                                 <span class="s1">&#39;TMin (C)&#39;</span><span class="p">:</span> <span class="n">diff_tmin</span><span class="p">,</span> <span class="s1">&#39;TDew (C)&#39;</span><span class="p">:</span> <span class="n">diff_tdew</span><span class="p">,</span>
                                 <span class="s1">&#39;Vapor Pres (kPa)&#39;</span><span class="p">:</span> <span class="n">diff_ea</span><span class="p">,</span> <span class="s1">&#39;RHAvg (%)&#39;</span><span class="p">:</span> <span class="n">diff_rhavg</span><span class="p">,</span> <span class="s1">&#39;RHMax (%)&#39;</span><span class="p">:</span> <span class="n">diff_rhmax</span><span class="p">,</span>
                                 <span class="s1">&#39;RHMin (%)&#39;</span><span class="p">:</span> <span class="n">diff_rhmin</span><span class="p">,</span> <span class="s1">&#39;Rs (w/m2)&#39;</span><span class="p">:</span> <span class="n">diff_rs</span><span class="p">,</span> <span class="s1">&#39;Opt - Orig Rs_TR (w/m2)&#39;</span><span class="p">:</span> <span class="n">diff_rs_tr</span><span class="p">,</span>
                                 <span class="s1">&#39;Rso (w/m2)&#39;</span><span class="p">:</span> <span class="n">diff_rso</span><span class="p">,</span> <span class="s1">&#39;Windspeed (m/s)&#39;</span><span class="p">:</span> <span class="n">diff_ws</span><span class="p">,</span> <span class="s1">&#39;Precip (mm)&#39;</span><span class="p">:</span> <span class="n">diff_precip</span><span class="p">,</span>
                                 <span class="s1">&#39;ETr (mm)&#39;</span><span class="p">:</span> <span class="n">diff_etr</span><span class="p">,</span> <span class="s1">&#39;ETo (mm)&#39;</span><span class="p">:</span> <span class="n">diff_eto</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">datetime_df</span><span class="p">)</span>

        <span class="c1"># Creating a fill dataframe that tracks where missing data was filled in</span>
        <span class="n">fill_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_year</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_month</span><span class="p">,</span>
                                <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_day</span><span class="p">,</span> <span class="s1">&#39;TMax (C)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmax</span><span class="p">,</span> <span class="s1">&#39;TMin (C)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_tmin</span><span class="p">,</span>
                                <span class="s1">&#39;TDew (C)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_tdew</span><span class="p">,</span> <span class="s1">&#39;Vapor Pres (kPa)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_ea</span><span class="p">,</span> <span class="s1">&#39;Rs (w/m2)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_rs</span><span class="p">,</span>
                                <span class="s1">&#39;Complete Record Rso (w/m2)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_rso</span><span class="p">,</span> <span class="s1">&#39;mm k0 values&#39;</span><span class="p">:</span> <span class="n">k_not_vals</span><span class="p">},</span>
                               <span class="n">index</span><span class="o">=</span><span class="n">datetime_df</span><span class="p">)</span>
        <span class="n">output_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
        <span class="n">delta_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
        <span class="n">fill_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
        <span class="c1"># Open up pandas excel writer</span>
        <span class="n">output_writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file_path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;xlsxwriter&#39;</span><span class="p">)</span>
        <span class="c1"># Convert data frames to xlsxwriter excel objects</span>
        <span class="n">output_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">output_writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Corrected Data&#39;</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_fill_value</span><span class="p">)</span>
        <span class="n">delta_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">output_writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Delta (Corr - Orig)&#39;</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_fill_value</span><span class="p">)</span>
        <span class="n">fill_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">output_writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;Filled Data&#39;</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_fill_value</span><span class="p">)</span>
        <span class="c1"># Save output file</span>
        <span class="n">output_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eto</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etr</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System: After finishing corrections and filling data, &quot;</span>
                      <span class="s2">&quot;ETr and ETo still had missing observations.&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;After finishing corrections and filling data, &#39;</span>
                             <span class="s1">&#39;ETr and ETo still had missing observations. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;The output file for this station has a complete record of ETo and ETr observations. </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The file has been successfully processed and output files saved at </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span>
                     <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="WeatherQC.process_station">
<a class="viewcode-back" href="../../agweatherqaqc.html#agweatherqaqc.agweatherqaqc.WeatherQC.process_station">[docs]</a>
    <span class="k">def</span> <span class="nf">process_station</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This function serves as the structure for the overall workflow in</span>
<span class="sd">            applying the QC process to an input data source. The standard process is as follows:</span>

<span class="sd">            1. Read in the data.</span>

<span class="sd">            2. Calculate any secondary variables (mean monthly values, clear-sky solar radiation, etc.).</span>

<span class="sd">            3. Plot the data before any corrections are performed.</span>

<span class="sd">            4. Allow the user to adjust/remove/QC data. Recompute any dependent secondary variables.</span>

<span class="sd">            5. Plot the data after corrections are performed and save the output data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obtain_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_secondary_vars</span><span class="p">()</span>
        <span class="c1"># first plot the data before correcting it</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System: Plotting raw data.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_plots</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">script_mode</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_correct_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_plots</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_outputs</span><span class="p">()</span></div>
</div>



<span class="c1"># This is never run by itself</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">This module does nothing if run by itself. &quot;</span>
          <span class="s2">&quot;Please see the script </span><span class="se">\&#39;</span><span class="s2">qaqc_single_station.py</span><span class="se">\&#39;</span><span class="s2"> for more info.&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Christian Dunkerly.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>